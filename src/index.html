<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title id="pageTitle">Unearthed | Archaeological Finds</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    :root {
      --bg: #f5f0e1;
      --surface: #ffffff;
      --accent: #4e6c50;
      --border: #d8d3c4;
      --text: #111;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .8rem;
      padding: .7rem 1rem .7rem .8rem;
      background: var(--surface);
      border-bottom: 1px solid rgba(0,0,0,.03);
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: .8rem;
      min-width: 0;
    }
    .logo-circle {
      width: 38px;
      height: 38px;
      border-radius: 9999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.6), rgba(78,108,80,1));
      display: grid;
      place-items: center;
      box-shadow: 0 3px 10px rgba(0,0,0,.15);
      flex: 0 0 auto;
    }
    .logo-circle svg {
      width: 22px;
      height: 22px;
      stroke: #fff;
      stroke-width: 1.5;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .brand-block {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
      min-width: 0;
    }
    .brand-title {
      font-weight: 700;
      letter-spacing: .04em;
      font-size: 1.02rem;
      white-space: nowrap;
      color: var(--text);
    }
    .brand-sub {
      font-size: .65rem;
      color: #666;
    }

    /* Language dropdown (discrete, top right) */
    .lang-toggle {
      position: relative;
    }
    .lang-current {
      background: rgba(0,0,0,0.03);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 999px;
      padding: .2rem .6rem;
      font-size: .78rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: .35rem;
      color: #111;
    }
    .lang-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 0.35rem);
      background: #fff;
      border: 1px solid rgba(0,0,0,.05);
      border-radius: .5rem;
      min-width: 130px;
      box-shadow: 0 8px 25px rgba(0,0,0,.1);
      display: none;
      z-index: 10;
      color: #111;
    }
    .lang-menu button {
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
      padding: .38rem .6rem;
      font-size: .78rem;
      cursor: pointer;
      color: #111;
    }
    .lang-menu button:hover {
      background: rgba(0,0,0,.05);
    }
    .lang-toggle.open .lang-menu {
      display: block;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      padding: 1.5rem 1rem 4rem 1rem;
      background: var(--surface);
      min-height: 100vh;
    }
    label {
      display: block;
      margin-top: 0.7em;
      font-weight: 600;
    }
    input, select, textarea, button {
      display: block;
      width: 100%;
      margin-top: 0.25em;
      font-size: 1em;
      box-sizing: border-box;
    }
    input, select, textarea {
      padding: 0.55em 0.6em;
      border: 1px solid #ccc;
      border-radius: 7px;
      background: #fff;
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid rgba(78,108,80,.22);
      border-color: var(--accent);
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      background: var(--accent);
      color: white;
      padding: 0.8em;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      margin-top: 1.2em;
      font-weight: 600;
    }
    button.secondary {
      background: #2f4f4f;
    }
    #map {
      height: 250px;
      margin-top: 1em;
      border-radius: 7px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.05);
    }
    .two-col {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      margin-bottom: 1.4rem;
    }
    .two-col > div {
      flex: 1;
      min-width: 260px;
      background: rgba(245,240,225,.4);
      border: 1px solid rgba(216,211,196,0.6);
      border-radius: 10px;
      padding: 1rem .9rem 1.1rem .9rem;
    }
    .email-options {
      margin-top: 1.1rem;
      background: #f7f7f7;
      padding: 0.7em 0.8em;
      border-radius: 7px;
      border: 1px solid rgba(0,0,0,.03);
    }
    .email-options label {
      font-weight: normal;
      display: flex;
      align-items: center;
      gap: 0.5em;
      margin-top: 0.4em;
    }
    .email-options input[type="checkbox"] {
      width: auto;
      display: inline-block;
      margin: 0;
    }
    .email-hint {
      font-size: 0.7rem;
      color: #555;
      margin-top: 0.5em;
    }
    @media (max-width: 700px) {
      .container {
        padding-inline: .8rem;
      }
      .two-col > div {
        background: #fff;
        border: none;
        padding: .5rem 0 0 0;
      }
    }
  </style>
</head>
<body>

<header class="topbar">
  <div class="topbar-left">
    <div class="logo-circle" aria-hidden="true">
      <!-- Metal detector icon -->
      <svg viewBox="0 0 24 24">
        <path d="M8 4h3" />
        <path d="M9.5 5 14 15" />
        <circle cx="16.5" cy="17.5" r="2.5" />
        <path d="M5 9c1.3-.8 2.6-.8 3.9 0" />
        <path d="M4 6c2-1.4 4-1.4 6 0" />
      </svg>
    </div>
    <div class="brand-block">
      <span class="brand-title" data-i18n="appName">Unearthed</span>
      <span class="brand-sub" data-i18n="appTagline">Find reporting for detectorists - A prototype webapp by Kodeklubben Sandsli</span>
    </div>
  </div>
  <div class="lang-toggle" id="langToggle">
    <button type="button" class="lang-current" id="langCurrent" aria-label="Change language">
      üåê <span id="langLabel">EN</span>
    </button>
    <div class="lang-menu" aria-label="Language menu">
      <button type="button" data-lang="en" onclick="setLanguageFromTopbar('en')">English</button>
      <button type="button" data-lang="no" onclick="setLanguageFromTopbar('no')">Norsk</button>
      <button type="button" data-lang="es" onclick="setLanguageFromTopbar('es')">Espa√±ol</button>
    </div>
  </div>
</header>

<div class="container">
  <h2 id="formTitle" data-i18n="pageHeading">Report a find</h2>
  <p id="introText" data-i18n="pageSub">
    Fill in the details below. Your GPS will be used, and the official PDF will be filled automatically.
  </p>

  <!-- Finder + Land owner -->
  <div class="two-col">
    <div>
      <h3 data-i18n="finderTitle">Finder</h3>
      <label for="finderName" data-i18n="labelName">Name</label>
      <input type="text" id="finderName" placeholder="Your full name" data-i18n-placeholder="phName" />
      <label for="finderAddress" data-i18n="labelAddress">Address</label>
      <input type="text" id="finderAddress" data-i18n-placeholder="phAddress" />
      <label for="finderPhone" data-i18n="labelPhone">Telephone</label>
      <input type="text" id="finderPhone" data-i18n-placeholder="phPhone" />
      <label for="finderEmail" data-i18n="labelEmail">Email</label>
      <input type="email" id="finderEmail" data-i18n-placeholder="phEmail" />
    </div>

    <div>
      <h3 data-i18n="ownerTitle">Land owner</h3>
      <label for="ownerName" data-i18n="labelName">Name</label>
      <input type="text" id="ownerName" data-i18n-placeholder="phOwnerName" />
      <label for="ownerAddress" data-i18n="labelAddress">Address</label>
      <input type="text" id="ownerAddress" data-i18n-placeholder="phAddress" />
      <label for="ownerPhone" data-i18n="labelPhone">Telephone</label>
      <input type="text" id="ownerPhone" data-i18n-placeholder="phPhone" />
      <label for="ownerEmail" data-i18n="labelEmail">Email</label>
      <input type="email" id="ownerEmail" data-i18n-placeholder="phEmail" />
      <label for="ownerKommune" data-i18n="labelKommune">Municipality</label>
      <input type="text" id="ownerKommune" data-i18n-placeholder="phKommune" />
      <label for="ownerGnr" data-i18n="labelGnr">Farm no. (Gnr)</label>
      <input type="text" id="ownerGnr" data-i18n-placeholder="phGnr" />
      <label for="ownerBnr" data-i18n="labelBnr">Holding no. (Bnr)</label>
      <input type="text" id="ownerBnr" data-i18n-placeholder="phBnr" />
    </div>
  </div>

  <form id="findForm" onsubmit="event.preventDefault();">
    <label for="objectName" data-i18n="labelObjectName">Object Name</label>
    <input type="text" id="objectName" required data-i18n-placeholder="phObjectName" />

    <label for="objectType" data-i18n="labelObjectType">Type of Object</label>
    <select id="objectType">
      <option data-i18n="optTool">Tool</option>
      <option data-i18n="optWeapon">Weapon</option>
      <option data-i18n="optJewelry">Jewelry</option>
      <option data-i18n="optPottery">Pottery</option>
      <option data-i18n="optOther">Other</option>
    </select>

    <label for="material" data-i18n="labelMaterial">Antatt materiale</label>
    <input type="text" id="material" data-i18n-placeholder="phMaterial" />

    <label for="age" data-i18n="labelAge">Estimated Age</label>
    <input type="text" id="age" data-i18n-placeholder="phAge" />

    <label for="arealtype" data-i18n="labelAreaType">Arealtype</label>
    <select id="arealtype">
      <option value="">--</option>
      <option value="√Öker" data-i18n="optArealAker">√Öker</option>
      <option value="Beite" data-i18n="optArealBeite">Beite</option>
      <option value="Hage" data-i18n="optArealHage">Hage</option>
      <option value="Skog" data-i18n="optArealSkog">Skog</option>
      <option value="Fjell" data-i18n="optArealFjell">Fjell</option>
      <option value="Strand" data-i18n="optArealStrand">Strand</option>
      <option value="Vann" data-i18n="optArealVann">Vann</option>
    </select>

    <label for="findDepth" data-i18n="labelDepth">Funndybde (cm)</label>
    <input type="number" id="findDepth" min="0" step="1" data-i18n-placeholder="phDepth" />

    <label for="location" data-i18n="labelLocation">Location</label>
    <input type="text" id="location" readonly required data-i18n-placeholder="phLocation" />
    <button type="button" onclick="useCurrentLocation()" data-i18n="btnUseLocation">
      Use current location
    </button>

    <div id="map"></div>

    <label for="photo" data-i18n="labelPhoto">Upload Photo</label>
    <input type="file" id="photo" accept="image/*" multiple />

    <label for="notes" data-i18n="labelNotes">Notes</label>
    <textarea id="notes" data-i18n-placeholder="phNotes"></textarea>

    <!-- Button changed: no implicit submit -->
    <button type="button" class="secondary" onclick="saveAsPDF()" data-i18n="btnDownload">
      Download official form (filled)
    </button>

    <div class="email-options">
      <label>
        <input type="checkbox" id="emailFinder" />
        <span data-i18n="cbEmailFinder">Send copy (data + PDF) to finder</span>
      </label>
      <label>
        <input type="checkbox" id="emailOwner" />
        <span data-i18n="cbEmailOwner">Send copy (data + PDF) to land owner</span>
      </label>
      <p class="email-hint" data-i18n="emailHint">
        NB: To send email you still need a small server endpoint.
      </p>
    </div>
  </form>
</div>

<!-- Debug Panel - MUST load before other scripts -->
<script>
(function() {
  var debugLogs = [];
  var debugPanel = null;
  var debugBtn = null;

  function createDebugUI() {
    if (debugBtn) return; // already created
    debugBtn = document.createElement("button");
    debugBtn.innerHTML = "&#128203;";
    debugBtn.setAttribute("style", 
      "position:fixed;bottom:10px;right:10px;z-index:10000;width:44px;height:44px;" +
      "border-radius:50%;border:2px solid #fff;background:#c00;color:#fff;font-size:18px;" +
      "cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,0.5);"
    );
    debugBtn.onclick = function() {
      if (debugPanel.style.display === "none") {
        debugPanel.style.display = "block";
        renderLogs();
      } else {
        debugPanel.style.display = "none";
      }
    };
    document.body.appendChild(debugBtn);

    debugPanel = document.createElement("div");
    debugPanel.setAttribute("style",
      "position:fixed;bottom:60px;left:10px;right:10px;max-height:40vh;z-index:9999;" +
      "background:rgba(0,0,0,0.95);color:#0f0;font-family:monospace;font-size:11px;" +
      "padding:10px;border-radius:8px;overflow-y:auto;display:none;white-space:pre-wrap;" +
      "word-break:break-all;border:2px solid #0f0;"
    );
    document.body.appendChild(debugPanel);
  }

  function renderLogs() {
    if (debugPanel) {
      debugPanel.textContent = debugLogs.join("\n") || "(no logs yet)";
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }
  }

  window.dbg = function(msg) {
    var ts = new Date().toLocaleTimeString();
    var entry = "[" + ts + "] " + msg;
    debugLogs.push(entry);
    if (debugLogs.length > 100) debugLogs.shift();
    if (typeof console !== "undefined") console.log(entry);
    renderLogs();
  };

  window.onerror = function(msg, url, line, col, err) {
    window.dbg("ERROR: " + msg + " at " + (url || "?") + ":" + line);
    return false;
  };

  if (document.body) {
    createDebugUI();
  } else {
    document.addEventListener("DOMContentLoaded", createDebugUI);
  }

  window.dbg("Debug init");
})();
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js" onerror="window.dbg && window.dbg('Leaflet load FAILED')"></script>
<script>window.dbg && window.dbg("Leaflet loaded: " + (typeof L !== "undefined"));</script>

<script src="i18n.js" onerror="window.dbg && window.dbg('i18n.js load FAILED')"></script>
<script>window.dbg && window.dbg("i18n.js loaded");</script>

<script src="map-and-location.js" onerror="window.dbg && window.dbg('map-and-location.js load FAILED')"></script>
<script>
window.dbg && window.dbg("map-and-location.js loaded");
window.dbg && window.dbg("AppMap exists: " + (typeof window.AppMap !== "undefined"));
window.dbg && window.dbg("useCurrentLocation exists: " + (typeof window.useCurrentLocation !== "undefined"));
// Force init if it didn't run
if (typeof window.AppMap !== "undefined" && typeof window.AppMap.initMapAndLocation === "function") {
  window.dbg("Calling initMapAndLocation directly");
  try {
    window.AppMap.initMapAndLocation();
  } catch(e) {
    window.dbg("Init error: " + e.message);
  }
}
</script>

<script src="export.js" onerror="window.dbg && window.dbg('export.js load FAILED')"></script>
<script>
window.dbg && window.dbg("export.js loaded");
window.dbg && window.dbg("saveAsPDF exists: " + (typeof window.saveAsPDF !== "undefined"));
</script>

<!-- Test map interaction inline -->
<script>
(function() {
  window.dbg && window.dbg("Checking map status...");
  var mapEl = document.getElementById("map");
  window.dbg && window.dbg("map element: " + (mapEl ? "found" : "NOT FOUND"));
  window.dbg && window.dbg("L (Leaflet): " + (typeof L));
  
  // Add a test click handler to the map element directly
  if (mapEl) {
    mapEl.addEventListener("click", function(e) {
      window.dbg && window.dbg("Raw click on #map div");
      // Check if Leaflet map is attached
      if (window.AppMap) {
        var latlon = window.AppMap.getLastLatLon();
        window.dbg && window.dbg("Last latlon: " + (latlon ? (latlon.lat + "," + latlon.lon) : "null"));
        var addrData = window.AppMap.getLastAddressData();
        window.dbg && window.dbg("Last addr data: " + (addrData ? JSON.stringify(addrData).substring(0,80) : "null"));
      }
      // Check owner fields
      var ownerAddr = document.getElementById("ownerAddress");
      window.dbg && window.dbg("ownerAddress value: " + (ownerAddr ? ownerAddr.value : "element not found"));
    });
  }
  
  // Add test for location button
  var locBtn = document.querySelector('button[onclick*="useCurrentLocation"]');
  window.dbg && window.dbg("Location button: " + (locBtn ? "found" : "NOT FOUND"));
  
  // Delayed check to see map state after init
  setTimeout(function() {
    window.dbg && window.dbg("=== Delayed map check ===");
    if (window.AppMap) {
      window.dbg && window.dbg("AppMap.getLastLatLon: " + (typeof window.AppMap.getLastLatLon));
      var addrData = window.AppMap.getLastAddressData();
      window.dbg && window.dbg("addressData after delay: " + (addrData ? "exists" : "null"));
    }
    // Check if Leaflet map container has the map
    var mapDiv = document.getElementById("map");
    if (mapDiv) {
      window.dbg && window.dbg("map div classes: " + mapDiv.className);
      window.dbg && window.dbg("map div children: " + mapDiv.children.length);
    }
    // Test XHR directly
    window.dbg && window.dbg("=== Testing XHR directly ===");
    try {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "https://ws.geonorge.no/adresser/v1/punktsok?lat=60.39&lon=5.32&radius=1000&treffPerSide=1", true);
      xhr.onload = function() {
        window.dbg && window.dbg("XHR test onload: " + xhr.status);
        if (xhr.status === 200) {
          window.dbg && window.dbg("XHR response: " + xhr.responseText.substring(0, 100));
        }
      };
      xhr.onerror = function() {
        window.dbg && window.dbg("XHR test onerror");
      };
      xhr.send();
      window.dbg && window.dbg("XHR test sent");
    } catch(e) {
      window.dbg && window.dbg("XHR test error: " + e.message);
    }
  }, 3000);
})();
</script>

<!-- Language dropdown behavior -->
<script>
  (function(){
    try {
      window.dbg && window.dbg("Lang dropdown init starting");
      var toggle = document.getElementById("langToggle");
      var current = document.getElementById("langCurrent");
      if (current) {
        current.addEventListener("click", function() { 
          toggle.classList.toggle("open"); 
        });
      }
      document.addEventListener("click", function(e) {
        if (toggle && !toggle.contains(e.target)) {
          toggle.classList.remove("open");
        }
      });
      window.dbg && window.dbg("Lang dropdown init done");
    } catch(e) {
      window.dbg && window.dbg("Lang dropdown error: " + e.message);
    }
  })();
  function setLanguageFromTopbar(lang) {
    if (typeof setLanguage === "function") setLanguage(lang);
    var label = document.getElementById("langLabel");
    if (label) label.textContent = lang.toUpperCase();
    var toggle = document.getElementById("langToggle");
    if (toggle) toggle.classList.remove("open");
  }
</script>

<!-- Prevent premature form submission -->
<script>
  try {
    window.dbg && window.dbg("Form script starting");
    document.addEventListener("DOMContentLoaded", function() {
      window.dbg && window.dbg("Form DOMContentLoaded handler");
      var form = document.getElementById("findForm");
      if (!form) {
        window.dbg && window.dbg("Form not found");
        return;
      }
      form.addEventListener("keydown", function(event) {
        // event.key might not exist in older Safari
        var key = event.key || event.keyCode;
        if (key === "Enter" || key === 13) {
          var tag = event.target.tagName.toLowerCase();
          if (tag !== "textarea") {
            event.preventDefault();
            return false;
          }
        }
      });
      window.dbg && window.dbg("Form keydown handler attached");
    });
    window.dbg && window.dbg("Form script done");
  } catch(e) {
    window.dbg && window.dbg("Form script error: " + e.message);
  }
</script>

</body>
</html>

