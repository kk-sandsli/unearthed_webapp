<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title id="pageTitle">Unearthed | Archaeological Finds</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    :root {
      --bg: #f5f0e1;
      --surface: #ffffff;
      --accent: #4e6c50;
      --border: #d8d3c4;
      --text: #111;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .8rem;
      padding: .7rem 1rem .7rem .8rem;
      background: var(--surface);
      border-bottom: 1px solid rgba(0,0,0,.03);
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: .8rem;
      min-width: 0;
    }
    .logo-circle {
      width: 38px;
      height: 38px;
      border-radius: 9999px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,.15);
      flex: 0 0 auto;
    }
    .logo-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .brand-block {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
      min-width: 0;
    }
    .brand-title {
      font-weight: 700;
      letter-spacing: .04em;
      font-size: 1.02rem;
      white-space: nowrap;
      color: var(--text);
    }
    .brand-sub {
      font-size: .65rem;
      color: #666;
    }

    /* Language dropdown (discrete, top right) */
    .topbar-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.3rem;
    }
    .topbar-btn {
      background: rgba(0,0,0,0.03);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 999px;
      padding: .2rem .6rem;
      font-size: .78rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: .35rem;
      color: #111;
      width: auto;
      margin: 0;
    }
    .topbar-btn:hover {
      background: rgba(0,0,0,0.08);
    }
    .lang-toggle {
      position: relative;
    }
    .lang-current {
      background: rgba(0,0,0,0.03);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 999px;
      padding: .2rem .6rem;
      font-size: .78rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: .35rem;
      color: #111;
    }
    .lang-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 0.35rem);
      background: #fff;
      border: 1px solid rgba(0,0,0,.05);
      border-radius: .5rem;
      min-width: 130px;
      box-shadow: 0 8px 25px rgba(0,0,0,.1);
      display: none;
      z-index: 10;
      color: #111;
    }
    .lang-menu button {
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
      padding: .38rem .6rem;
      font-size: .78rem;
      cursor: pointer;
      color: #111;
    }
    .lang-menu button:hover {
      background: rgba(0,0,0,.05);
    }
    .lang-toggle.open .lang-menu {
      display: block;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      padding: 1rem 1rem 4rem 1rem;
      background: var(--surface);
      min-height: 100vh;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 0.3em;
    }
    h3 {
      margin-top: 0;
      margin-bottom: 0.4em;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-header > label:first-child {
      margin-top: 0;
    }
    .approval-check {
      display: flex;
      align-items: center;
      gap: 0.3em;
      font-size: 0.85em;
      font-weight: normal;
      margin: 0;
    }
    .approval-check input {
      width: auto;
      margin: 0;
    }
    label {
      display: block;
      margin-top: 0.7em;
      font-weight: 600;
    }
    input, select, textarea, button {
      display: block;
      width: 100%;
      margin-top: 0.25em;
      font-size: 1em;
      box-sizing: border-box;
    }
    input, select, textarea {
      padding: 0.55em 0.6em;
      border: 1px solid #ccc;
      border-radius: 7px;
      background: #fff;
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid rgba(78,108,80,.22);
      border-color: var(--accent);
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      background: var(--accent);
      color: white;
      padding: 0.8em;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      margin-top: 1.2em;
      font-weight: 600;
    }
    button.secondary {
      background: #2f4f4f;
    }
    #map {
      height: 300px;
      margin-top: 1em;
      border-radius: 7px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.05);
    }
    .two-col {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      margin-bottom: 1.4rem;
    }
    .two-col > div {
      flex: 1;
      min-width: 260px;
      background: rgba(245,240,225,.4);
      border: 1px solid rgba(216,211,196,0.6);
      border-radius: 10px;
      padding: 1rem .9rem 1.1rem .9rem;
    }

    @media (max-width: 700px) {
      .container {
        padding-inline: .8rem;
      }
      .two-col > div {
        background: #fff;
        border: none;
        padding: .5rem 0 0 0;
      }
    }

    /* Coordinate system toggle button */
    .coord-toggle {
      display: inline-block;
      width: auto;
      min-width: 70px;
      padding: 0.4em 0.7em;
      margin: 0;
      font-size: 0.8em;
      font-weight: 600;
      background: #e8e4d9;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      text-align: center;
    }
    .coord-toggle:hover {
      background: var(--accent);
      color: #fff;
    }
    .location-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.25em;
    }
    .location-row input {
      flex: 1;
      margin-top: 0;
    }

    /* Two-column row for Gnr/Bnr fields */
    .gnr-bnr-row {
      display: flex;
      gap: 1rem;
    }
    .gnr-bnr-row > div {
      flex: 1;
    }
    .gnr-bnr-row label {
      display: block;
    }
    .gnr-bnr-row input {
      width: 100%;
      box-sizing: border-box;
    }

    /* Address marker icon (prevents default Leaflet icon styling) */
    .address-marker {
      background: transparent;
      border: none;
    }

    /* Inline clear buttons for input fields */
    .input-clearable {
      position: relative;
      display: block;
      width: 100%;
    }
    .input-clearable input,
    .input-clearable textarea {
      padding-right: 2em;
      width: 100%;
      box-sizing: border-box;
    }
    .clear-field-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #aaa;
      font-size: 1.1rem;
      cursor: pointer;
      padding: 0 4px;
      width: auto;
      margin: 0;
      display: none;
      line-height: 1;
    }
    .clear-field-btn:hover {
      color: #666;
    }
    /* For textarea, position at top-right */
    .input-clearable.textarea-wrap .clear-field-btn {
      top: 12px;
      transform: none;
    }
    /* For file input, position clear button at far right without overlapping native button */
    .input-clearable input[type="file"] {
      padding-right: 2.5em;
    }
  </style>
</head>
<body>

<header class="topbar">
  <div class="topbar-left">
    <div class="logo-circle" aria-hidden="true">
      <img src="unearthed-icon-no-coin.svg" alt="Unearthed logo">
    </div>
    <div class="brand-block">
      <span class="brand-title" data-i18n="appName">Unearthed</span>
      <span class="brand-sub" data-i18n="appTagline">Find reporting for detectorists - A prototype webapp by Kodeklubben Sandsli</span>
    </div>
  </div>
  <div class="topbar-right">
    <button type="button" class="topbar-btn" id="resetBtn" onclick="resetForm()" aria-label="Reset form">
      ‚Ü∫ <span data-i18n="btnReset">Reset</span>
    </button>
    <div class="lang-toggle" id="langToggle">
      <button type="button" class="lang-current" id="langCurrent" aria-label="Change language">
        üåê <span id="langLabel">EN</span>
      </button>
      <div class="lang-menu" aria-label="Language menu">
        <button type="button" data-lang="en" onclick="setLanguageFromTopbar('en')">English</button>
        <button type="button" data-lang="no" onclick="setLanguageFromTopbar('no')">Norsk</button>
        <button type="button" data-lang="es" onclick="setLanguageFromTopbar('es')">Espa√±ol</button>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <h2 id="formTitle" data-i18n="pageHeading">Report a find</h2>
  <p id="introText" data-i18n="pageSub">
    Fill in the details below. Your GPS will be used, and the official PDF will be filled automatically.
  </p>

  <!-- Finder + Land owner -->
  <div class="two-col">
    <div>
      <h3 data-i18n="finderTitle">Finder</h3>
      <label for="finderName" data-i18n="labelName">Name</label>
      <input type="text" id="finderName" placeholder="Your full name" data-i18n-placeholder="phName" />
      <label for="finderAddress" data-i18n="labelAddress">Address</label>
      <input type="text" id="finderAddress" data-i18n-placeholder="phAddress" />
      <label for="finderPhone" data-i18n="labelPhone">Telephone</label>
      <input type="text" id="finderPhone" data-i18n-placeholder="phPhone" />
      <label for="finderEmail" data-i18n="labelEmail">Email</label>
      <input type="email" id="finderEmail" data-i18n-placeholder="phEmail" />
    </div>

    <div>
      <div class="section-header">
        <h3 data-i18n="ownerTitle">Land owner</h3>
        <label class="approval-check">
          <input type="checkbox" id="ownerApproval" />
          <span data-i18n="labelApproval">Search approved</span>
        </label>
      </div>
      <label for="ownerName" data-i18n="labelName">Name</label>
      <input type="text" id="ownerName" data-i18n-placeholder="phOwnerName" />
      <label for="ownerPhone" data-i18n="labelPhone">Telephone</label>
      <input type="text" id="ownerPhone" data-i18n-placeholder="phPhone" />
      <label for="ownerEmail" data-i18n="labelEmail">Email</label>
      <input type="email" id="ownerEmail" data-i18n-placeholder="phEmail" />
      <div class="section-header">
        <label for="ownerAddress" data-i18n="labelAddress">Address</label>
        <label class="approval-check">
          <input type="checkbox" id="autoFillAddress" checked />
          <span data-i18n="labelAutoFill">Auto-fill from map</span>
        </label>
      </div>
      <input type="text" id="ownerAddress" data-i18n-placeholder="phAddress" />
      <label for="ownerKommune" id="labelKommuneEl" data-i18n="labelkommune">Municipality</label>
      <input type="text" id="ownerKommune" autocomplete="off" data-i18n-placeholder="phkommune" />
      <div class="gnr-bnr-row">
        <div>
          <label for="ownerGnr" id="labelGnrEl" data-i18n="labelgnr">Farm no. (Gnr)</label>
          <input type="text" id="ownerGnr" autocomplete="off" data-i18n-placeholder="phgnr" />
        </div>
        <div>
          <label for="ownerBnr" id="labelBnrEl" data-i18n="labelbnr">Holding no. (Bnr)</label>
          <input type="text" id="ownerBnr" autocomplete="off" data-i18n-placeholder="phbnr" />
        </div>
      </div>
    </div>
  </div>

  <form id="findForm" onsubmit="event.preventDefault();">
    <div id="map"></div>
    <p class="map-hint" style="font-size: 0.85em; color: #666; margin-top: 0.5em;" data-i18n="mapHint">
      Tap the map to select location, or use the button below for GPS. Blue marker shows find location, green circle shows nearest address.
    </p>

    <button type="button" onclick="useCurrentLocation()" data-i18n="btnUseLocation">
      Use current GPS location
    </button>

    <label for="location" data-i18n="labelLocation">Location</label>
    <div class="location-row">
      <input type="text" id="location" readonly required data-i18n-placeholder="phLocation" />
      <button type="button" id="coordToggle" class="coord-toggle" onclick="toggleCoordSystem()" title="Click to toggle coordinate system">UTM32</button>
    </div>

    <label for="objectName" data-i18n="labelObjectName">Object Name</label>
    <input type="text" id="objectName" required data-i18n-placeholder="phObjectName" />

    <label for="objectType" data-i18n="labelObjectType">Type of Object</label>
    <select id="objectType">
      <option data-i18n="optTool">Tool</option>
      <option data-i18n="optWeapon">Weapon</option>
      <option data-i18n="optJewelry">Jewelry</option>
      <option data-i18n="optPottery">Pottery</option>
      <option data-i18n="optOther">Other</option>
    </select>

    <label for="material" data-i18n="labelMaterial">Antatt materiale</label>
    <input type="text" id="material" data-i18n-placeholder="phMaterial" />

    <label for="age" data-i18n="labelAge">Estimated Age</label>
    <input type="text" id="age" data-i18n-placeholder="phAge" />

    <label for="arealtype" data-i18n="labelAreaType">Arealtype</label>
    <select id="arealtype">
      <option value="">--</option>
      <option value="√Öker" data-i18n="optArealAker">√Öker</option>
      <option value="Beite" data-i18n="optArealBeite">Beite</option>
      <option value="Hage" data-i18n="optArealHage">Hage</option>
      <option value="Skog" data-i18n="optArealSkog">Skog</option>
      <option value="Fjell" data-i18n="optArealFjell">Fjell</option>
      <option value="Strand" data-i18n="optArealStrand">Strand</option>
      <option value="Vann" data-i18n="optArealVann">Vann</option>
    </select>

    <label for="findDepth" data-i18n="labelDepth">Funndybde (cm)</label>
    <input type="number" id="findDepth" min="0" step="1" data-i18n-placeholder="phDepth" />

    <label for="photo" data-i18n="labelPhoto">Upload Photo</label>
    <input type="file" id="photo" accept="image/*" multiple />

    <label for="notes" data-i18n="labelNotes">Notes</label>
    <textarea id="notes" data-i18n-placeholder="phNotes"></textarea>

    <!-- Button changed: no implicit submit -->
    <button type="button" class="secondary" onclick="saveAsPDF()" data-i18n="btnDownload">
      Download official form (filled)
    </button>
    <p class="pdf-hint" style="font-size: 0.85em; color: #666; margin-top: 0.5em;" data-i18n="pdfEditHint">
      Note: The PDF may not be editable on phones, but will be on a computer.
    </p>


  </form>
</div>

<!-- Debug Panel - MUST load before other scripts -->
<script>
(function() {
  // Check for ?debug=1 in URL
  var debugEnabled = /[?&]debug=1/.test(window.location.search);
  
  // Always define window.dbg as a no-op if debug is disabled
  if (!debugEnabled) {
    window.dbg = function() {};
    return; // Exit early - no debug infrastructure
  }
  
  // Debug mode enabled - create full infrastructure
  var debugLogs = [];
  var debugPanel = null;
  var debugBtn = null;

  function createDebugUI() {
    if (debugBtn) return; // already created
    debugBtn = document.createElement("button");
    debugBtn.innerHTML = "&#128203;";
    debugBtn.setAttribute("style", 
      "position:fixed;bottom:10px;right:10px;z-index:10000;width:44px;height:44px;" +
      "border-radius:50%;border:2px solid #fff;background:#c00;color:#fff;font-size:18px;" +
      "cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,0.5);"
    );
    debugBtn.onclick = function() {
      if (debugPanel.style.display === "none") {
        debugPanel.style.display = "block";
        renderLogs();
      } else {
        debugPanel.style.display = "none";
      }
    };
    document.body.appendChild(debugBtn);

    debugPanel = document.createElement("div");
    debugPanel.setAttribute("style",
      "position:fixed;bottom:60px;left:10px;right:10px;max-height:40vh;z-index:9999;" +
      "background:rgba(0,0,0,0.95);color:#0f0;font-family:monospace;font-size:11px;" +
      "padding:10px;border-radius:8px;overflow-y:auto;display:none;white-space:pre-wrap;" +
      "word-break:break-all;border:2px solid #0f0;"
    );
    document.body.appendChild(debugPanel);
  }

  function renderLogs() {
    if (debugPanel) {
      debugPanel.textContent = debugLogs.join("\n") || "(no logs yet)";
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }
  }

  window.dbg = function(msg) {
    var ts = new Date().toLocaleTimeString();
    var entry = "[" + ts + "] " + msg;
    debugLogs.push(entry);
    if (debugLogs.length > 100) debugLogs.shift();
    if (typeof console !== "undefined") console.log(entry);
    renderLogs();
  };

  window.onerror = function(msg, url, line, col, err) {
    window.dbg("ERROR: " + msg + " at " + (url || "?") + ":" + line);
    return false;
  };

  if (document.body) {
    createDebugUI();
  } else {
    document.addEventListener("DOMContentLoaded", createDebugUI);
  }

  window.dbg("Debug init");
})();
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js" crossorigin="anonymous" onerror="window.dbg && window.dbg('Leaflet load FAILED')"></script>
<script>window.dbg && window.dbg("Leaflet loaded: " + (typeof L !== "undefined"));</script>

<script src="i18n.js" onerror="window.dbg && window.dbg('i18n.js load FAILED')"></script>
<script>window.dbg && window.dbg("i18n.js loaded");</script>

<script src="map-and-location.js" onerror="window.dbg && window.dbg('map-and-location.js load FAILED')"></script>
<script>
window.dbg && window.dbg("map-and-location.js loaded");
window.dbg && window.dbg("AppMap exists: " + (typeof window.AppMap !== "undefined"));
window.dbg && window.dbg("useCurrentLocation exists: " + (typeof window.useCurrentLocation !== "undefined"));
// Force init if it didn't run
if (typeof window.AppMap !== "undefined" && typeof window.AppMap.initMapAndLocation === "function") {
  window.dbg("Calling initMapAndLocation directly");
  try {
    window.AppMap.initMapAndLocation();
  } catch(e) {
    window.dbg("Init error: " + e.message);
  }
}
</script>

<!-- Finder persistence (inline for Safari compatibility - no async/await) -->
<script>
(function() {
  var dbg = window.dbg || function(){};
  var FINDER_KEY = "unearthed-finder";
  
  dbg("[finder] Inline finder script running");
  
  function isStorageAvailable() {
    try {
      var t = "__test__";
      localStorage.setItem(t, t);
      localStorage.removeItem(t);
      return true;
    } catch(e) {
      return false;
    }
  }
  
  function loadFinder() {
    if (!isStorageAvailable()) {
      dbg("[finder] localStorage not available");
      return null;
    }
    try {
      var s = localStorage.getItem(FINDER_KEY);
      dbg("[finder] Raw stored: " + (s ? s : "(empty)"));
      return s ? JSON.parse(s) : null;
    } catch(e) {
      dbg("[finder] Load error: " + e.message);
      return null;
    }
  }
  
  function saveFinder() {
    if (!isStorageAvailable()) return;
    try {
      var finder = {
        name: (document.getElementById("finderName") || {}).value || "",
        address: (document.getElementById("finderAddress") || {}).value || "",
        phone: (document.getElementById("finderPhone") || {}).value || "",
        email: (document.getElementById("finderEmail") || {}).value || ""
      };
      var json = JSON.stringify(finder);
      localStorage.setItem(FINDER_KEY, json);
      dbg("[finder] Saved: " + json.substring(0, 50));
      
      // Verify
      var verify = localStorage.getItem(FINDER_KEY);
      dbg("[finder] Verified: " + (verify === json ? "OK" : "MISMATCH"));
    } catch(e) {
      dbg("[finder] Save error: " + e.message);
    }
  }
  
  function prefillFinder() {
    var finder = loadFinder();
    if (!finder) {
      dbg("[finder] Nothing to prefill");
      return;
    }
    dbg("[finder] Prefilling: " + finder.name);
    var fields = [
      ["finderName", finder.name],
      ["finderAddress", finder.address],
      ["finderPhone", finder.phone],
      ["finderEmail", finder.email]
    ];
    for (var i = 0; i < fields.length; i++) {
      var el = document.getElementById(fields[i][0]);
      if (el && fields[i][1]) {
        el.value = fields[i][1];
        dbg("[finder] Set " + fields[i][0]);
      }
    }
  }
  
  function setupAutoSave() {
    var ids = ["finderName", "finderAddress", "finderPhone", "finderEmail"];
    for (var i = 0; i < ids.length; i++) {
      var el = document.getElementById(ids[i]);
      if (el) {
        el.addEventListener("blur", saveFinder);
        el.addEventListener("change", saveFinder);
      }
    }
    dbg("[finder] Auto-save listeners attached");
  }
  
  function initFinder() {
    dbg("[finder] Init starting");
    prefillFinder();
    setupAutoSave();
    dbg("[finder] Init complete");
  }
  
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initFinder);
  } else {
    initFinder();
  }
  
  dbg("[finder] Inline script done");
})();
</script>

<!-- Load export.js with error catching for Safari debugging -->
<script>
(function() {
  var dbg = window.dbg || function(){};
  dbg("[loader] Loading export.js via XHR to catch parse errors...");
  
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "export.js", true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      dbg("[loader] export.js fetched, length: " + xhr.responseText.length);
      try {
        // Try to evaluate the script
        var fn = new Function(xhr.responseText);
        fn();
        dbg("[loader] export.js executed OK");
      } catch(e) {
        dbg("[loader] export.js PARSE/EXEC ERROR: " + e.message);
        dbg("[loader] Error name: " + e.name);
        dbg("[loader] Error line: " + (e.line || e.lineNumber || "unknown"));
        // Try to find the problematic line
        if (e.message) {
          dbg("[loader] Full error: " + String(e));
        }
      }
    } else {
      dbg("[loader] export.js fetch failed: " + xhr.status);
    }
  };
  xhr.onerror = function() {
    dbg("[loader] export.js XHR error");
  };
  xhr.send();
})();
</script>
<script>
window.dbg && window.dbg("export.js loader done");
window.dbg && window.dbg("saveAsPDF exists: " + (typeof window.saveAsPDF !== "undefined"));
</script>

<!-- Test map interaction inline -->
<script>
(function() {
  window.dbg && window.dbg("Checking map status...");
  var mapEl = document.getElementById("map");
  window.dbg && window.dbg("map element: " + (mapEl ? "found" : "NOT FOUND"));
  window.dbg && window.dbg("L (Leaflet): " + (typeof L));
  
  // Add a test click handler to the map element directly
  if (mapEl) {
    mapEl.addEventListener("click", function(e) {
      try {
        window.dbg && window.dbg("Raw click on #map div");
        // Check if Leaflet map is attached
        if (window.AppMap) {
          var latlon = window.AppMap.getLastLatLon ? window.AppMap.getLastLatLon() : null;
          window.dbg && window.dbg("Last latlon: " + (latlon ? (latlon.lat + "," + latlon.lon) : "null"));
          var addrData = window.AppMap.getLastAddressData ? window.AppMap.getLastAddressData() : null;
          window.dbg && window.dbg("Last addr data: " + (addrData ? JSON.stringify(addrData).substring(0,80) : "null"));
          
          // If no address data but we have latlon, try fetching inline
          if (latlon && !addrData) {
            window.dbg && window.dbg("=== Inline fetch test ===");
            var url = "https://ws.geonorge.no/adresser/v1/punktsok" +
              "?lat=" + latlon.lat +
              "&lon=" + latlon.lon +
              "&radius=10000&treffPerSide=1";
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onload = function() {
              window.dbg && window.dbg("Inline fetch status: " + xhr.status);
              if (xhr.status === 200) {
                try {
                  var data = JSON.parse(xhr.responseText);
                  if (data.adresser && data.adresser.length > 0) {
                    var addr = data.adresser[0];
                    window.dbg && window.dbg("Inline got: " + addr.adressetekst);
                    // Update fields directly
                    var ownerAddr = document.getElementById("ownerAddress");
                    if (ownerAddr) {
                      var fullAddr = addr.adressetekst || "";
                      if (addr.postnummer && addr.poststed) {
                        fullAddr += ", " + addr.postnummer + " " + addr.poststed;
                      }
                      ownerAddr.value = fullAddr;
                      window.dbg && window.dbg("Set ownerAddress: " + fullAddr);
                    }
                    var kommune = document.getElementById("ownerKommune");
                    if (kommune) kommune.value = addr.kommunenavn || "";
                    var gnr = document.getElementById("ownerGnr");
                    if (gnr) gnr.value = addr.gardsnummer || "";
                    var bnr = document.getElementById("ownerBnr");
                    if (bnr) bnr.value = addr.bruksnummer || "";
                    window.dbg && window.dbg("Owner fields updated inline!");
                  } else {
                    window.dbg && window.dbg("Inline: no addresses");
                  }
                } catch(pe) {
                  window.dbg && window.dbg("Inline parse error: " + pe.message);
                }
              }
            };
            xhr.onerror = function() {
              window.dbg && window.dbg("Inline fetch error");
            };
            xhr.send();
            window.dbg && window.dbg("Inline fetch sent");
          }
        }
        // Check owner fields
        var ownerAddr = document.getElementById("ownerAddress");
        window.dbg && window.dbg("ownerAddress value: " + (ownerAddr ? ("'" + ownerAddr.value + "'") : "element not found"));
      } catch(err) {
        window.dbg && window.dbg("Click handler error: " + err.message);
      }
    });
  }
  
  // Add test for location button
  var locBtn = document.querySelector('button[onclick*="useCurrentLocation"]');
  window.dbg && window.dbg("Location button: " + (locBtn ? "found" : "NOT FOUND"));
  
  // Delayed check to see map state after init
  setTimeout(function() {
    try {
      window.dbg && window.dbg("=== Delayed check (3s) ===");
      if (window.AppMap) {
        window.dbg && window.dbg("AppMap keys: " + Object.keys(window.AppMap).join(", "));
      }
      // Check if Leaflet map container has the map
      var mapDiv = document.getElementById("map");
      if (mapDiv) {
        window.dbg && window.dbg("map div classes: " + mapDiv.className);
      }
      // Test XHR directly
      window.dbg && window.dbg("=== Testing XHR ===");
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "https://ws.geonorge.no/adresser/v1/punktsok?lat=60.39&lon=5.32&radius=1000&treffPerSide=1", true);
      xhr.onload = function() {
        window.dbg && window.dbg("XHR onload: " + xhr.status);
        if (xhr.status === 200) {
          window.dbg && window.dbg("XHR OK: " + xhr.responseText.substring(0, 80));
        }
      };
      xhr.onerror = function() {
        window.dbg && window.dbg("XHR onerror");
      };
      xhr.send();
      window.dbg && window.dbg("XHR sent");
    } catch(e) {
      window.dbg && window.dbg("Delayed check error: " + e.message);
    }
  }, 3000);
})();
</script>

<!-- Language dropdown behavior -->
<script>
  (function(){
    try {
      window.dbg && window.dbg("Lang dropdown init starting");
      var toggle = document.getElementById("langToggle");
      var current = document.getElementById("langCurrent");
      if (current) {
        current.addEventListener("click", function() { 
          toggle.classList.toggle("open"); 
        });
      }
      document.addEventListener("click", function(e) {
        if (toggle && !toggle.contains(e.target)) {
          toggle.classList.remove("open");
        }
      });
      window.dbg && window.dbg("Lang dropdown init done");
    } catch(e) {
      window.dbg && window.dbg("Lang dropdown error: " + e.message);
    }
  })();
  function setLanguageFromTopbar(lang) {
    if (typeof setLanguage === "function") setLanguage(lang);
    var label = document.getElementById("langLabel");
    if (label) label.textContent = lang.toUpperCase();
    var toggle = document.getElementById("langToggle");
    if (toggle) toggle.classList.remove("open");
  }
</script>

<!-- Reset form function -->
<script>
  function resetForm() {
    var dbg = window.dbg || function(){};
    dbg("[reset] resetForm called");
    
    // Get confirmation message based on current language
    var lang = localStorage.getItem("unearthed-lang") || "no";
    var confirmMsgs = {
      en: "Clear all form fields (except finder info)?",
      no: "T√∏m alle skjemafelt (unntatt finnerinfo)?",
      es: "¬øBorrar todos los campos (excepto datos del descubridor)?"
    };
    var msg = confirmMsgs[lang] || confirmMsgs.en;
    
    if (!confirm(msg)) {
      dbg("[reset] User cancelled");
      return;
    }
    
    dbg("[reset] Clearing fields");
    
    // Fields to clear (excludes finder info which is persisted)
    var fieldsToClear = [
      "ownerName", "ownerAddress", "ownerPhone", "ownerEmail",
      "ownerKommune", "ownerGnr", "ownerBnr",
      "objectName", "material", "age", "findDepth", "location", "notes"
    ];
    
    for (var i = 0; i < fieldsToClear.length; i++) {
      var el = document.getElementById(fieldsToClear[i]);
      if (el) el.value = "";
    }
    
    // Reset select elements to first option
    var objectType = document.getElementById("objectType");
    if (objectType) objectType.selectedIndex = 0;
    var arealtype = document.getElementById("arealtype");
    if (arealtype) arealtype.selectedIndex = 0;
    
    // Clear photo input
    var photo = document.getElementById("photo");
    if (photo) photo.value = "";
    
    // Clear map markers (address marker and circle)
    if (window.AppMap && window.AppMap.clearAddressMarker) {
      window.AppMap.clearAddressMarker();
      dbg("[reset] Address marker cleared");
    }
    
    dbg("[reset] Form reset complete");
  }
</script>

<!-- Inline clear buttons for input fields -->
<script>
(function() {
  var clearableFields = [
    "finderName", "finderAddress", "finderPhone", "finderEmail",
    "ownerName", "ownerAddress", "ownerPhone", "ownerEmail",
    "ownerKommune", "ownerGnr", "ownerBnr",
    "objectName", "material", "age", "findDepth", "notes", "photo"
  ];
  
  function setupClearButtons() {
    var dbg = window.dbg || function(){};
    dbg("[clearBtns] Setting up clear buttons");
    
    for (var i = 0; i < clearableFields.length; i++) {
      var fieldId = clearableFields[i];
      var field = document.getElementById(fieldId);
      if (!field) continue;
      
      // Skip if already wrapped
      if (field.parentNode.classList && field.parentNode.classList.contains("input-clearable")) continue;
      
      // Create wrapper
      var wrapper = document.createElement("div");
      wrapper.className = "input-clearable";
      if (field.tagName.toLowerCase() === "textarea") {
        wrapper.className += " textarea-wrap";
      }
      field.parentNode.insertBefore(wrapper, field);
      wrapper.appendChild(field);
      
      // Create clear button
      var btn = document.createElement("button");
      btn.type = "button";
      btn.className = "clear-field-btn";
      btn.innerHTML = "√ó";
      btn.setAttribute("aria-label", "Clear field");
      btn.setAttribute("tabindex", "-1");
      wrapper.appendChild(btn);
      
      // Show/hide based on field content
      (function(f, b) {
        function updateVisibility() {
          b.style.display = f.value ? "block" : "none";
        }
        f.addEventListener("input", updateVisibility);
        f.addEventListener("change", updateVisibility);
        updateVisibility();
        
        b.addEventListener("click", function(e) {
          e.preventDefault();
          f.value = "";
          b.style.display = "none";
          f.focus();
          var evt = document.createEvent("HTMLEvents");
          evt.initEvent("change", true, false);
          f.dispatchEvent(evt);
        });
      })(field, btn);
    }
    dbg("[clearBtns] Setup complete");
  }
  
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupClearButtons);
  } else {
    setupClearButtons();
  }
})();
</script>

<!-- Prevent premature form submission -->
<script>
  try {
    window.dbg && window.dbg("Form script starting");
    document.addEventListener("DOMContentLoaded", function() {
      window.dbg && window.dbg("Form DOMContentLoaded handler");
      var form = document.getElementById("findForm");
      if (!form) {
        window.dbg && window.dbg("Form not found");
        return;
      }
      form.addEventListener("keydown", function(event) {
        // event.key might not exist in older Safari
        var key = event.key || event.keyCode;
        if (key === "Enter" || key === 13) {
          var tag = event.target.tagName.toLowerCase();
          if (tag !== "textarea") {
            event.preventDefault();
            return false;
          }
        }
      });
      window.dbg && window.dbg("Form keydown handler attached");
    });
    window.dbg && window.dbg("Form script done");
  } catch(e) {
    window.dbg && window.dbg("Form script error: " + e.message);
  }
</script>

</body>
</html>

